import streamlit as st
import pandas as pd
import base64
import itertools
from collections import Counter

st.set_page_config(layout="wide")
st.title("Rozlosování (nejen) mariášových turnajů")

# ===== SEATING DEFINITIONS =====
SEATING_DEFINITIONS = {
    # 3členné skupiny
    '9_3': {
        'group_size': 3,
        'description': "Kirkman Triple System (KTS(9)) - ověřeno",
        'rounds': [
            [[1,2,3], [4,5,6], [7,8,9]],
            [[1,4,7], [2,5,8], [3,6,9]],
            [[1,5,9], [2,6,7], [3,4,8]],
            [[1,6,8], [2,4,9], [3,5,7]]
        ]
    },
    '12_3': {
        'group_size': 3,
        'description': "Kirkman Triple System (KTS(12)) - ověřeno",
        'rounds': [
            [[1,2,3], [4,5,6], [7,8,9], [10,11,12]],
            [[1,4,10], [5,7,11], [2,6,8], [3,9,12]],
            [[1,5,9], [4,8,12], [2,7,10], [3,6,11]],
            [[2,5,12], [1,8,11], [4,7,3], [10,6,9]]
        ]
    },
    '15_3': {
        'group_size': 3,
        'description': "Kirkman Triple System (KTS(15)) - ověřeno",
        'rounds': [
            [[1,2,3],[4,5,6],[7,8,9],[10,11,12],[13,14,15]],
            [[1,4,7],[2,5,10],[3,6,13],[8,11,14],[9,12,15]],
            [[1,5,14],[2,4,15],[3,8,12],[6,9,11],[7,10,13]],
            [[1,9,13],[2,7,12],[3,4,11],[5,8,15],[6,10,14]],
            [[1,8,10],[2,11,13],[3,5,9],[4,12,14],[6,7,15]],
            [[1,6,12],[2,9,14],[3,10,15],[4,8,13],[5,7,11]],
            [[1,11,15],[2,6,8],[3,7,14],[4,9,10],[5,12,13]]
        ]
    },
    '18_3': {
        'group_size': 3,
        'description': "Kirkman Triple System (KTS(18)) - ověřeno",
        'rounds': [
            [[1,2,3],[4,5,6],[7,8,9],[10,17,15],[13,11,18],[16,14,12]],
            [[1,11,12],[4,14,15],[7,17,18],[10,8,6],[13,2,9],[16,5,3]],
            [[10,11,3],[13,14,6],[16,17,9],[1,8,15],[4,2,18],[7,5,12]],
            [[10,2,12],[13,5,15],[16,8,18],[1,17,6],[4,11,9],[7,14,3]],
            [[1,4,7],[2,5,8],[3,6,9],[10,14,18],[11,15,16],[12,13,17]],
            [[1,13,16],[2,14,17],[3,15,18],[10,5,9],[11,6,7],[12,4,8]],
            [[10,13,7],[11,14,8],[12,15,9],[1,5,18],[2,6,16],[3,4,17]],
            [[10,4,16],[11,5,17],[12,6,18],[1,14,9],[2,15,7],[3,13,8]]
        ]
    },
    '21_3': {
        'group_size': 3,
        'description': "Kirkman Triple System (KTS(21)) - ověřeno",
        'rounds': [
            [[1,2,6],[5,7,13],[4,11,18],[9,14,16],[3,10,20],[8,15,21],[12,17,19]],
            [[4,5,10],[8,9,11],[2,14,15],[1,17,18],[3,12,21],[6,13,19],[7,16,20]],
            [[1,8,12],[10,11,15],[5,9,17],[3,14,18],[2,7,19],[4,13,20],[6,16,21]],
            [[2,3,4],[6,8,14],[5,12,16],[7,15,17],[1,11,20],[9,13,21],[10,18,19]],
            [[5,6,11],[9,7,12],[3,15,13],[2,18,16],[1,10,21],[4,14,19],[8,17,20]],
            [[2,9,10],[11,12,13],[6,7,18],[1,15,16],[3,8,19],[5,14,20],[4,17,21]],
            [[3,1,5],[4,9,15],[6,10,17],[8,13,18],[2,12,20],[7,14,21],[11,16,19]],
            [[6,4,12],[7,8,10],[1,13,14],[3,16,17],[2,11,21],[5,15,19],[9,18,20]],
            [[3,7,11],[12,10,14],[4,8,16],[2,13,17],[1,9,19],[6,15,20],[5,18,21]],
            [[19,20,21],[1,4,7],[2,5,8],[3,6,9],[10,13,16],[11,14,17],[12,15,18]]
        ]
    },
    '24_3': {
        'group_size': 3,
        'description': "Kirkman Triple System (KTS(24)) - ověřeno",
        'rounds': [
            [[1,2,3],[4,5,6],[7,8,9],[10,11,12],[13,14,15],[16,17,18],[19,20,21],[22,23,24]],
            [[10,15,20],[5,19,2],[1,16,9],[4,13,12],[8,3,22],[17,23,14],[6,11,21],[7,18,24]],
            [[4,22,11],[19,6,15],[10,17,9],[5,8,12],[16,20,7],[23,18,3],[2,13,21],[1,14,24]],
            [[5,7,13],[6,2,22],[4,23,9],[19,16,12],[17,11,1],[18,14,20],[15,8,21],[10,3,24]],
            [[19,1,8],[2,15,7],[5,18,9],[6,17,12],[23,13,10],[14,3,11],[22,16,21],[4,20,24]],
            [[6,10,16],[15,22,1],[19,14,9],[2,23,12],[18,8,4],[3,20,13],[7,17,21],[5,11,24]],
            [[2,4,17],[22,7,10],[6,3,9],[15,18,12],[14,16,5],[20,11,8],[1,23,21],[19,13,24]],
            [[15,5,23],[7,1,4],[2,20,9],[22,14,12],[3,17,19],[11,13,16],[10,18,21],[6,8,24]],
            [[22,19,18],[1,10,5],[15,11,9],[7,3,12],[20,23,6],[13,8,17],[4,14,21],[2,16,24]],
            [[7,6,14],[10,4,19],[22,13,9],[1,20,12],[11,18,2],[8,16,23],[5,3,21],[15,17,24]]
        ]
    },
    '27_3': {
        'group_size': 3,
        'description': "Kirkman Triple System (KTS(27)) - ověřeno",
        'rounds': [
            [[25,26,27],[1,2,3],[4,5,6],[7,8,9],[10,11,12],[13,14,15],[16,17,18],[19,20,21],[22,23,24]],
            [[13,20,18],[4,23,27],[19,12,26],[1,14,21],[22,2,6],[5,15,25],[7,10,16],[9,24,3],[8,11,17]],
            [[10,17,15],[16,9,26],[22,11,18],[19,23,3],[2,12,25],[1,20,27],[4,7,13],[6,21,24],[5,8,14]],
            [[19,2,24],[11,21,25],[10,5,27],[1,18,26],[7,20,3],[4,8,12],[15,6,9],[14,17,23],[13,16,22]],
            [[1,8,6],[10,14,18],[17,3,25],[16,11,27],[7,24,26],[13,2,9],[19,22,4],[21,12,15],[20,23,5]],
            [[7,14,12],[19,8,15],[16,20,24],[23,9,25],[22,17,27],[13,6,26],[3,18,21],[2,5,11],[1,4,10]],
            [[16,23,21],[7,2,27],[22,15,26],[4,17,24],[1,5,9],[8,18,25],[11,14,20],[10,13,19],[12,3,6]],
            [[22,5,3],[14,24,25],[13,8,27],[4,21,26],[10,23,6],[7,11,15],[16,19,1],[18,9,12],[17,20,2]],
            [[4,11,9],[13,17,21],[20,6,25],[19,14,27],[10,3,26],[16,5,12],[23,2,8],[22,1,7],[24,15,18]],
            [[13,5,24],[10,20,9],[4,2,18],[1,17,12],[22,8,21],[16,14,6],[15,3,27],[11,23,26],[19,7,25]],
            [[7,17,6],[1,23,15],[22,14,9],[19,5,18],[13,11,3],[10,2,21],[12,24,27],[8,20,26],[16,4,25]],
            [[22,20,12],[19,11,6],[16,2,15],[10,8,24],[7,23,18],[4,14,3],[5,17,26],[13,1,25],[9,21,27]],
            [[16,8,3],[13,23,12],[7,5,21],[4,20,15],[1,11,24],[19,17,9],[10,22,25],[6,18,27],[2,14,26]]
        ]
    },
    '30_3': {
        'group_size': 3,
        'description': "Kirkman Triple System (KTS(30)) - ověřeno",
        'rounds': [
            [[1,2,3],[4,5,6],[7,8,9],[10,11,12],[13,14,15],[16,17,18],[19,20,21],[22,23,24],[25,26,27],[28,29,30]],
            [[1,4,7],[2,5,10],[3,6,13],[8,11,14],[9,12,15],[16,19,22],[17,20,25],[18,21,28],[23,26,29],[24,27,30]],
            [[1,5,14],[2,4,15],[3,8,12],[6,9,11],[7,10,13],[16,20,29],[17,19,30],[18,23,27],[21,24,26],[22,25,28]],
            [[1,9,13],[2,7,12],[3,4,11],[5,8,15],[6,10,14],[16,24,28],[17,22,27],[18,19,26],[20,23,30],[21,25,29]],
            [[1,8,10],[2,11,13],[3,5,9],[4,12,14],[6,7,15],[16,23,25],[17,26,28],[18,20,24],[19,27,29],[21,22,30]],
            [[1,6,12],[2,9,14],[3,10,15],[4,8,13],[5,7,11],[16,21,27],[17,24,29],[18,25,30],[19,23,28],[20,22,26]],
            [[1,11,15],[2,6,8],[3,7,14],[4,9,10],[5,12,13],[16,26,30],[17,21,23],[18,22,29],[19,24,25],[20,27,28]]
        ]
    },
    '33_3': {
        'group_size': 3,
        'description': "Kirkman Triple System (KTS(33)) - ověřeno",
        'rounds': [
            [[1,2,3],[4,5,6],[7,8,9],[10,17,15],[13,11,18],[16,14,12],[19,20,21],[22,23,24],[25,26,27],[28,29,30],[31,32,33]],
            [[1,11,12],[4,14,15],[7,17,18],[10,8,6],[13,2,9],[16,5,3],[19,23,32],[20,22,33],[21,26,30],[24,27,29],[25,28,31]],
            [[10,11,3],[13,14,6],[16,17,9],[1,8,15],[4,2,18],[7,5,12],[19,22,25],[20,23,28],[21,24,31],[26,29,32],[27,30,33]],
            [[10,2,12],[13,5,15],[16,8,18],[1,17,6],[4,11,9],[7,14,3],[19,27,31],[20,25,30],[21,22,29],[23,26,33],[24,28,32]],
            [[1,4,7],[2,5,8],[3,6,9],[10,14,18],[11,15,16],[12,13,17],[19,26,28],[20,29,31],[21,23,27],[22,30,32],[24,25,33]],
            [[1,13,16],[2,14,17],[3,15,18],[10,5,9],[11,6,7],[12,4,8],[19,24,30],[20,27,32],[21,28,33],[22,26,31],[23,25,29]],
            [[10,13,7],[11,14,8],[12,15,9],[1,5,18],[2,6,16],[3,4,17],[19,29,33],[20,24,26],[21,25,32],[22,27,28],[23,30,31]]
        ]
    },
    '36_3': {
        'group_size': 3,
        'description': "Kirkman Triple System (KTS(36)) - ověřeno",
        'rounds': [
            [[1,2,3],[4,5,6],[7,8,9],[10,17,15],[13,11,18],[16,14,12],[19,20,21],[22,23,24],[25,26,27],[28,35,33],[31,29,36],[34,32,30]],
            [[1,11,12],[4,14,15],[7,17,18],[10,8,6],[13,2,9],[16,5,3],[19,29,30],[22,32,33],[25,35,36],[28,26,24],[31,20,27],[34,23,21]],
            [[10,11,3],[13,14,6],[16,17,9],[1,8,15],[4,2,18],[7,5,12],[28,29,21],[31,32,24],[34,35,27],[19,26,33],[22,20,36],[25,23,30]],
            [[10,2,12],[13,5,15],[16,8,18],[1,17,6],[4,11,9],[7,14,3],[28,20,30],[31,23,33],[34,26,36],[19,35,24],[22,29,27],[25,32,21]],
            [[1,4,7],[2,5,8],[3,6,9],[10,14,18],[11,15,16],[12,13,17],[19,22,25],[20,23,26],[21,24,27],[28,32,36],[29,33,34],[30,31,35]],
            [[1,13,16],[2,14,17],[3,15,18],[10,5,9],[11,6,7],[12,4,8],[19,31,34],[20,32,35],[21,33,36],[28,23,27],[29,24,25],[30,22,26]],
            [[10,13,7],[11,14,8],[12,15,9],[1,5,18],[2,6,16],[3,4,17],[28,31,25],[29,32,26],[30,33,27],[19,23,36],[20,24,34],[21,22,35]],
            [[10,4,16],[11,5,17],[12,6,18],[1,14,9],[2,15,7],[3,13,8],[28,22,34],[29,23,35],[30,24,36],[19,32,27],[20,33,25],[21,31,26]]
        ]
    },
    '39_3': {
        'group_size': 3,
        'description': "Kirkman Triple System (KTS(39)) - ověřeno",
        'rounds': [
            [[1,2,6],[5,7,13],[4,11,18],[9,14,16],[3,10,20],[8,15,21],[12,17,19],[22,23,24],[25,26,27],[28,29,30],[31,38,36],[34,32,39],[37,35,33]],
            [[4,5,10],[8,9,11],[2,14,15],[1,17,18],[3,12,21],[6,13,19],[7,16,20],[22,32,33],[25,35,36],[28,38,39],[31,29,27],[34,23,30],[37,26,24]],
            [[1,8,12],[10,11,15],[5,9,17],[3,14,18],[2,7,19],[4,13,20],[6,16,21],[31,32,24],[34,35,27],[37,38,30],[22,29,36],[25,23,39],[28,26,33]],
            [[2,3,4],[6,8,14],[5,12,16],[7,15,17],[1,11,20],[9,13,21],[10,18,19],[31,23,33],[34,26,36],[37,29,39],[22,38,27],[25,32,30],[28,35,24]],
            [[5,6,11],[9,7,12],[3,15,13],[2,18,16],[1,10,21],[4,14,19],[8,17,20],[22,25,28],[23,26,29],[24,27,30],[31,35,39],[32,36,37],[33,34,38]],
            [[2,9,10],[11,12,13],[6,7,18],[1,15,16],[3,8,19],[5,14,20],[4,17,21],[22,34,37],[23,35,38],[24,36,39],[31,26,30],[32,27,28],[33,25,29]],
            [[3,1,5],[4,9,15],[6,10,17],[8,13,18],[2,12,20],[7,14,21],[11,16,19],[31,34,28],[32,35,29],[33,36,30],[22,26,39],[23,27,37],[24,25,38]],
            [[6,4,12],[7,8,10],[1,13,14],[3,16,17],[2,11,21],[5,15,19],[9,18,20],[31,25,37],[32,26,38],[33,27,39],[22,35,30],[23,36,28],[24,34,29]]
        ]
    },
    
    # 4členné skupiny
    '16_4': {
        'group_size': 4,
        'description': "Řešitelný Steinerův čtyřnásobný systém (RSQS(16)) - ověřeno",
        'rounds': [
            [[1,2,3,4], [5,6,7,8], [9,10,11,12], [13,14,15,16]],
            [[1,5,9,13], [2,6,10,14], [3,7,11,15], [4,8,12,16]],
            [[1,6,11,16], [2,5,12,15], [3,8,9,14], [4,7,10,13]],
            [[1,7,12,14], [2,8,11,13], [3,5,10,16], [4,6,9,15]],
            [[1,8,10,15], [2,7,9,16], [3,6,12,13], [4,5,11,14]]
        ]
    },
    '20_4': {
        'group_size': 4,
        'description': "Řešitelný Steinerův čtyřnásobný systém (RSQS(20)) - ověřeno",
        'rounds': [
            [[1, 2, 3, 4], [5, 6, 7, 8], [9, 10, 11, 12], [13, 14, 15, 16], [17, 18, 19, 20]],
            [[1, 5, 9, 13], [2, 6, 10, 17], [3, 7, 14, 18], [4, 11, 15, 19], [8, 12, 16, 20]],
            [[1, 6, 15, 20], [2, 5, 12, 18], [3, 9, 16, 19], [4, 7, 10, 13], [8, 11, 14, 17]],
            [[1, 10, 16, 18], [2, 8, 13, 19], [3, 5, 11, 20], [4, 6, 9, 14], [7, 12, 15, 17]],
            [[1, 12, 14, 19], [2, 7, 9, 20], [3, 8, 10, 15], [4, 5, 16, 17], [6, 11, 13, 18]]
        ]
    },
    '24_4': {
        'group_size': 4,
        'description': "Řešitelný Steinerův čtyřnásobný systém (RSQS(24)) - ověřeno",
        'rounds': [
            [[1,2,11,21],[9,10,19,5],[17,18,3,13],[4,7,6,24],[8,12,14,15],[16,20,22,23]],
            [[1,3,12,22],[9,11,20,6],[17,19,4,14],[5,8,7,18],[2,13,15,16],[10,21,23,24]],
            [[1,4,13,23],[9,12,21,7],[17,20,5,15],[6,2,8,19],[3,10,14,16],[11,18,22,24]],
            [[1,5,14,24],[9,13,22,8],[17,21,6,16],[7,3,2,20],[4,10,11,15],[12,18,19,23]],
            [[1,6,15,18],[9,14,23,2],[17,22,7,10],[8,4,3,21],[5,11,12,16],[13,19,20,24]],
            [[1,7,16,19],[9,15,24,3],[17,23,8,11],[2,5,4,22],[6,10,12,13],[14,18,20,21]],
            [[1,8,10,20],[9,16,18,4],[17,24,2,12],[3,6,5,23],[7,11,13,14],[15,19,21,22]]
        ]
    },
    '28_4': {
        'group_size': 4,
        'description': "Řešitelný Steinerův čtyřnásobný systém (RSQS(28)) - ověřeno",
        'rounds': [
            [[1,2,3,4],[5,6,7,8],[9,10,11,12],[13,14,15,16],[17,18,19,20],[21,22,23,24],[25,26,27,28]],
            [[1,5,21,25],[2,6,13,17],[14,18,22,26],[7,9,19,27],[8,10,15,23],[3,11,16,28],[4,12,20,24]],
            [[1,6,24,28],[2,5,15,19],[16,20,23,27],[8,11,17,26],[7,12,13,22],[3,9,14,25],[4,10,18,21]],
            [[1,9,17,23],[2,10,14,28],[5,11,13,24],[6,12,18,27],[16,19,21,26],[3,7,15,20],[4,8,22,25]],
            [[1,7,16,18],[2,8,21,27],[5,12,14,23],[15,17,22,28],[6,11,20,25],[3,10,19,24],[4,9,13,26]],
            [[1,11,19,22],[2,12,16,25],[6,9,15,21],[5,10,20,26],[14,17,24,27],[3,8,13,18],[4,7,23,28]],
            [[1,8,14,20],[2,7,24,26],[6,10,16,22],[13,19,23,25],[5,9,18,28],[3,12,17,21],[4,11,15,27]],
            [[1,12,15,26],[2,11,18,23],[7,10,17,25],[13,20,21,28],[8,9,16,24],[3,5,22,27],[4,6,14,19]],
            [[1,10,13,27],[2,9,20,22],[3,6,23,26],[4,5,16,17],[7,11,14,21],[8,12,19,28],[15,18,24,25]]
        ]
    },
    '32_4': {
        'group_size': 4,
        'description': "Řešitelný Steinerův čtyřnásobný systém (RSQS(32)) - ověřeno",
        'rounds': [
            [[1,2,3,4],[5,6,7,8],[9,10,11,12],[13,14,16,15],[17,18,19,20],[21,22,23,24],[25,26,27,28],[29,30,31,32]],
            [[1,5,9,29],[2,23,19,8],[4,6,11,32],[27,16,20,22],[13,17,21,25],[3,24,18,7],[26,14,31,12],[28,10,30,15]],
            [[1,28,31,22],[2,24,27,29],[4,14,7,25],[6,17,12,15],[13,18,8,11],[3,16,21,10],[5,26,19,32],[23,9,20,30]],
            [[1,19,25,12],[2,26,20,11],[4,27,18,10],[6,23,31,16],[22,7,15,32],[3,9,28,17],[5,24,13,30],[14,21,8,29]],
            [[1,23,14,11],[2,5,28,16],[4,9,31,8],[24,20,25,15],[18,21,12,32],[3,26,22,29],[6,13,19,10],[27,17,7,30]],
            [[1,24,10,32],[2,6,25,30],[4,19,29,15],[9,14,18,22],[28,21,7,11],[3,13,31,20],[5,23,27,12],[26,16,17,8]],
            [[1,6,20,21],[2,31,7,10],[4,5,17,22],[24,28,14,19],[16,25,11,29],[3,8,12,30],[23,26,18,15],[9,27,13,32]],
            [[1,16,18,30],[2,14,17,32],[4,23,28,13],[27,31,19,21],[22,8,25,10],[3,5,11,15],[6,24,9,26],[20,7,12,29]],
            [[1,26,13,7],[2,9,21,15],[4,24,16,12],[23,17,10,29],[19,22,11,30],[3,6,27,14],[5,31,18,25],[28,20,8,32]],
            [[1,27,8,15],[2,13,22,12],[4,26,21,30],[6,28,18,29],[9,16,19,7],[3,23,25,32],[5,14,20,10],[24,31,17,11]]
        ]
    },
    '36_4': {
        'group_size': 4,
        'description': "Řešitelný Steinerův čtyřnásobný systém (RSQS(36)) - zatím pouze 5 kol z 11 možných",
        'rounds': [
            [[1,2,3,4],[5,6,7,8],[9,10,11,12],[13,14,15,16],[17,18,19,20],[21,22,23,24],[25,26,27,28],[29,30,31,32],[33,34,35,36]],
            [[1,5,9,13],[2,6,10,17],[3,7,14,18],[4,11,15,19],[8,12,16,20],[21,25,29,33],[22,26,30,34],[23,27,31,35],[24,28,32,36]],
            [[1,6,15,20],[2,5,12,18],[3,9,16,19],[4,7,10,13],[8,11,14,17],[21,26,31,36],[22,25,32,35],[23,28,29,34],[24,27,30,33]],
            [[1,10,16,18],[2,8,13,19],[3,5,11,20],[4,6,9,14],[7,12,15,17],[21,27,32,34],[22,28,31,33],[23,25,30,36],[24,26,29,35]],
            [[1,12,14,19],[2,7,9,20],[3,8,10,15],[4,5,16,17],[6,11,13,18],[21,28,30,35],[22,27,29,36],[23,26,32,33],[24,25,31,34]]
        ]
    },
    '40_4': {
        'group_size': 4,
        'description': "Řešitelný Steinerův čtyřnásobný systém (RSQS(40)) - zatím pouze 5 kol z X možných",
        'rounds': [
            [[1,2,3,4],[5,6,7,8],[9,10,11,12],[13,14,15,16],[17,18,19,20],[21,22,23,24],[25,26,27,28],[29,30,31,32],[33,34,35,36],[37,38,39,40]],
            [[1,5,9,13],[2,6,10,17],[3,7,14,18],[4,11,15,19],[8,12,16,20],[21,25,29,33],[22,26,30,37],[23,27,34,38],[24,31,35,39],[28,32,36,40]],
            [[1,6,15,20],[2,5,12,18],[3,9,16,19],[4,7,10,13],[8,11,14,17],[21,26,35,40],[22,25,32,38],[23,29,36,39],[24,27,30,33],[28,31,34,37]],
            [[1,10,16,18],[2,8,13,19],[3,5,11,20],[4,6,9,14],[7,12,15,17],[21,30,36,38],[22,28,33,39],[23,25,31,40],[24,26,29,34],[27,32,35,37]],
            [[1,12,14,19],[2,7,9,20],[3,8,10,15],[4,5,16,17],[6,11,13,18],[21,32,34,39],[22,27,29,40],[23,28,30,35],[24,25,36,37],[26,31,33,38]]
        ]
    },
    '44_4': {
        'group_size': 4,
        'description': "Řešitelný Steinerův čtyřnásobný systém (RSQS(44)) - zatím pouze 5 kol z X možných",
        'rounds': [
            [[1,2,11,21],[9,10,19,5],[17,18,3,13],[4,7,6,24],[8,12,14,15],[16,20,22,23],[25,26,27,28],[29,30,31,32],[33,34,35,36],[37,38,39,40],[41,42,43,44]],
            [[1,3,12,22],[9,11,20,6],[17,19,4,14],[5,8,7,18],[2,13,15,16],[10,21,23,24],[25,29,33,37],[26,30,34,41],[27,31,38,42],[28,35,39,43],[32,36,40,44]],
            [[1,4,13,23],[9,12,21,7],[17,20,5,15],[6,2,8,19],[3,10,14,16],[11,18,22,24],[25,30,39,44],[26,29,36,42],[27,33,40,43],[28,31,34,37],[32,35,38,41]],
            [[1,5,14,24],[9,13,22,8],[17,21,6,16],[7,3,2,20],[4,10,11,15],[12,18,19,23],[25,34,40,42],[26,32,37,43],[27,29,35,44],[28,30,33,38],[31,36,39,41]],
            [[1,7,16,19],[9,15,24,3],[17,23,8,11],[2,5,4,22],[6,10,12,13],[14,18,20,21],[25,36,38,43],[26,31,33,44],[27,32,34,39],[28,29,40,41],[30,35,37,42]]
        ]
    },
    '48_4': {
        'group_size': 4,
        'description': "Řešitelný Steinerův čtyřnásobný systém (RSQS(48)) - zatím pouze 7 kol z X možných",
        'rounds': [
            [[1,2,11,21],[9,10,19,5],[17,18,3,13],[4,7,6,24],[8,12,14,15],[16,20,22,23],[25,26,35,45],[33,34,43,29],[41,42,27,37],[28,31,30,48],[32,36,38,39],[40,44,46,47]],
            [[1,3,12,22],[9,11,20,6],[17,19,4,14],[5,8,7,18],[2,13,15,16],[10,21,23,24],[25,27,36,46],[33,35,44,30],[41,43,28,38],[29,32,31,42],[26,37,39,40],[34,45,47,48]],
            [[1,4,13,23],[9,12,21,7],[17,20,5,15],[6,2,8,19],[3,10,14,16],[11,18,22,24],[25,28,37,47],[33,36,45,31],[41,44,29,39],[30,26,32,43],[27,34,38,40],[35,42,46,48]],
            [[1,5,14,24],[9,13,22,8],[17,21,6,16],[7,3,2,20],[4,10,11,15],[12,18,19,23],[25,29,38,48],[33,37,46,32],[41,45,30,40],[31,27,26,44],[28,34,35,39],[36,42,43,47]],
            [[1,6,15,18],[9,14,23,2],[17,22,7,10],[8,4,3,21],[5,11,12,16],[13,19,20,24],[25,30,39,42],[33,38,47,26],[41,46,31,34],[32,28,27,45],[29,35,36,40],[37,43,44,48]],
            [[1,7,16,19],[9,15,24,3],[17,23,8,11],[2,5,4,22],[6,10,12,13],[14,18,20,21],[25,31,40,43],[33,39,48,27],[41,47,32,35],[26,29,28,46],[30,34,36,37],[38,42,44,45]],
            [[1,8,10,20],[9,16,18,4],[17,24,2,12],[3,6,5,23],[7,11,13,14],[15,19,21,22],[25,32,34,44],[33,40,42,28],[41,48,26,36],[27,30,29,47],[31,35,37,38],[39,43,45,46]]
        ]
    },
    '52_4': {
        'group_size': 4,
        'description': "Řešitelný Steinerův čtyřnásobný systém (RSQS(52)) - zatím pouze 7 kol z X možných",
        'rounds': [
            [[1,2,11,21],[9,10,19,5],[17,18,3,13],[4,7,6,24],[8,12,14,15],[16,20,22,23],[25,26,27,28],[29,30,31,32],[33,34,35,36],[37,38,39,40],[41,42,43,44],[45,46,47,48],[49,50,51,52]],
            [[1,3,12,22],[9,11,20,6],[17,19,4,14],[5,8,7,18],[2,13,15,16],[10,21,23,24],[25,29,45,49],[26,30,37,41],[38,42,46,50],[31,33,43,51],[32,34,39,47],[27,35,40,52],[28,36,44,48]],
            [[1,4,13,23],[9,12,21,7],[17,20,5,15],[6,2,8,19],[3,10,14,16],[11,18,22,24],[25,30,48,52],[26,29,39,43],[40,44,47,51],[32,35,41,50],[31,36,37,46],[27,33,38,49],[28,34,42,45]],
            [[1,5,14,24],[9,13,22,8],[17,21,6,16],[7,3,2,20],[4,10,11,15],[12,18,19,23],[25,33,41,47],[26,34,38,52],[29,35,37,48],[30,36,42,51],[40,43,45,50],[27,31,39,44],[28,32,46,49]],
            [[1,6,15,18],[9,14,23,2],[17,22,7,10],[8,4,3,21],[5,11,12,16],[13,19,20,24],[25,31,40,42],[26,32,45,51],[29,36,38,47],[39,41,46,52],[30,35,44,49],[27,34,43,48],[28,33,37,50]],
            [[1,7,16,19],[9,15,24,3],[17,23,8,11],[2,5,4,22],[6,10,12,13],[14,18,20,21],[25,35,43,46],[26,36,40,49],[30,33,39,45],[29,34,44,50],[38,41,48,51],[27,32,37,42],[28,31,47,52]],
            [[1,8,10,20],[9,16,18,4],[17,24,2,12],[3,6,5,23],[7,11,13,14],[15,19,21,22],[25,32,38,44],[26,31,48,50],[30,34,40,46],[37,43,47,49],[29,33,42,52],[27,36,41,45],[28,35,39,51]]
        ]
        },
    '56_4': {
        'group_size': 4,
        'description': "Řešitelný Steinerův čtyřnásobný systém (RSQS(56)) - zatím pouze 9 kol z X možných",
        'rounds': [
            [[1,2,3,4],[5,6,7,8],[9,10,11,12],[13,14,15,16],[17,18,19,20],[21,22,23,24],[25,26,27,28],[29,30,31,32],[33,34,35,36],[37,38,39,40],[41,42,43,44],[45,46,47,48],[49,50,51,52],[53,54,55,56]],
            [[1,5,21,25],[2,6,13,17],[14,18,22,26],[7,9,19,27],[8,10,15,23],[3,11,16,28],[4,12,20,24],[29,33,49,53],[30,34,41,45],[42,46,50,54],[35,37,47,55],[36,38,43,51],[31,39,44,56],[32,40,48,52]],
            [[1,6,24,28],[2,5,15,19],[16,20,23,27],[8,11,17,26],[7,12,13,22],[3,9,14,25],[4,10,18,21],[29,34,52,56],[30,33,43,47],[44,48,51,55],[36,39,45,54],[35,40,41,50],[31,37,42,53],[32,38,46,49]],
            [[1,9,17,23],[2,10,14,28],[5,11,13,24],[6,12,18,27],[16,19,21,26],[3,7,15,20],[4,8,22,25],[29,37,45,51],[30,38,42,56],[33,39,41,52],[34,40,46,55],[44,47,49,54],[31,35,43,48],[32,36,50,53]],
            [[1,7,16,18],[2,8,21,27],[5,12,14,23],[15,17,22,28],[6,11,20,25],[3,10,19,24],[4,9,13,26],[29,35,44,46],[30,36,49,55],[33,40,42,51],[43,45,50,56],[34,39,48,53],[31,38,47,52],[32,37,41,54]],
            [[1,11,19,22],[2,12,16,25],[6,9,15,21],[5,10,20,26],[14,17,24,27],[3,8,13,18],[4,7,23,28],[29,39,47,50],[30,40,44,53],[34,37,43,49],[33,38,48,54],[42,45,52,55],[31,36,41,46],[32,35,51,56]],
            [[1,8,14,20],[2,7,24,26],[6,10,16,22],[13,19,23,25],[5,9,18,28],[3,12,17,21],[4,11,15,27],[29,36,42,48],[30,35,52,54],[34,38,44,50],[41,47,51,53],[33,37,46,56],[31,40,45,49],[32,39,43,55]],
            [[1,12,15,26],[2,11,18,23],[7,10,17,25],[13,20,21,28],[8,9,16,24],[3,5,22,27],[4,6,14,19],[29,40,43,54],[30,39,46,51],[35,38,45,53],[41,48,49,56],[36,37,44,52],[31,33,50,55],[32,34,42,47]],
            [[1,10,13,27],[2,9,20,22],[3,6,23,26],[4,5,16,17],[7,11,14,21],[8,12,19,28],[15,18,24,25],[29,38,41,55],[30,37,48,50],[31,34,51,54],[32,33,44,45],[35,39,42,49],[36,40,47,56],[43,46,52,53]]
        ]
    },
    '128_4': {
        'group_size': 4,
        'description': "Řešitelný Steinerův čtyřnásobný systém (RSQS(128)) - ověřeno",
        'rounds': [
            [[1,2,3,4],[5,6,7,8],[9,10,11,12],[13,14,16,15],[17,18,19,20],[21,22,23,24],[25,26,27,28],[29,30,31,32],[33,34,35,36],[37,38,39,40],[41,42,43,44],[45,46,48,47],[49,50,51,52],[53,54,55,56],[57,58,59,60],[61,62,63,64],[65,66,67,68],[69,70,71,72],[73,74,75,76],[77,78,80,79],[81,82,83,84],[85,86,87,88],[89,90,91,92],[93,94,95,96],[97,98,99,100],[101,102,103,104],[105,106,107,108],[109,110,112,111],[113,114,115,116],[117,118,119,120],[121,122,123,124],[125,126,127,128]],
            [[1,5,9,29],[2,23,19,8],[4,6,11,32],[27,16,20,22],[13,17,21,25],[3,24,18,7],[26,14,31,12],[28,10,30,15],[33,37,41,61],[34,55,51,40],[36,38,43,64],[59,48,52,54],[45,49,53,57],[35,56,50,39],[58,46,63,44],[60,42,62,47],[65,69,73,93],[66,87,83,72],[68,70,75,96],[91,80,84,86],[77,81,85,89],[67,88,82,71],[90,78,95,76],[92,74,94,79],[97,101,105,125],[98,119,115,104],[100,102,107,128],[123,112,116,118],[109,113,117,121],[99,120,114,103],[122,110,127,108],[124,106,126,111]],
            [[1,28,31,22],[2,24,27,29],[4,14,7,25],[6,17,12,15],[13,18,8,11],[3,16,21,10],[5,26,19,32],[23,9,20,30],[33,60,63,54],[34,56,59,61],[36,46,39,57],[38,49,44,47],[45,50,40,43],[35,48,53,42],[37,58,51,64],[55,41,52,62],[65,92,95,86],[66,88,91,93],[68,78,71,89],[70,81,76,79],[77,82,72,75],[67,80,85,74],[69,90,83,96],[87,73,84,94],[97,124,127,118],[98,120,123,125],[100,110,103,121],[102,113,108,111],[109,114,104,107],[99,112,117,106],[101,122,115,128],[119,105,116,126]],
            [[1,19,25,12],[2,26,20,11],[4,27,18,10],[6,23,31,16],[22,7,15,32],[3,9,28,17],[5,24,13,30],[14,21,8,29],[33,51,57,44],[34,58,52,43],[36,59,50,42],[38,55,63,48],[54,39,47,64],[35,41,60,49],[37,56,45,62],[46,53,40,61],[65,83,89,76],[66,90,84,75],[68,91,82,74],[70,87,95,80],[86,71,79,96],[67,73,92,81],[69,88,77,94],[78,85,72,93],[97,115,121,108],[98,122,116,107],[100,123,114,106],[102,119,127,112],[118,103,111,128],[99,105,124,113],[101,120,109,126],[110,117,104,125]],
            [[1,23,14,11],[2,5,28,16],[4,9,31,8],[24,20,25,15],[18,21,12,32],[3,26,22,29],[6,13,19,10],[27,17,7,30],[33,55,46,43],[34,37,60,48],[36,41,63,40],[56,52,57,47],[50,53,44,64],[35,58,54,61],[38,45,51,42],[59,49,39,62],[65,87,78,75],[66,69,92,80],[68,73,95,72],[88,84,89,79],[82,85,76,96],[67,90,86,93],[70,77,83,74],[91,81,71,94],[97,119,110,107],[98,101,124,112],[100,105,127,104],[120,116,121,111],[114,117,108,128],[99,122,118,125],[102,109,115,106],[123,113,103,126]],
            [[1,24,10,32],[2,6,25,30],[4,19,29,15],[9,14,18,22],[28,21,7,11],[3,13,31,20],[5,23,27,12],[26,16,17,8],[33,56,42,64],[34,38,57,62],[36,51,61,47],[41,46,50,54],[60,53,39,43],[35,45,63,52],[37,55,59,44],[58,48,49,40],[65,88,74,96],[66,70,89,94],[68,83,93,79],[73,78,82,86],[92,85,71,75],[67,77,95,84],[69,87,91,76],[90,80,81,72],[97,120,106,128],[98,102,121,126],[100,115,125,111],[105,110,114,118],[124,117,103,107],[99,109,127,116],[101,119,123,108],[122,112,113,104]],
            [[1,6,20,21],[2,31,7,10],[4,5,17,22],[24,28,14,19],[16,25,11,29],[3,8,12,30],[23,26,18,15],[9,27,13,32],[33,38,52,53],[34,63,39,42],[36,37,49,54],[56,60,46,51],[48,57,43,61],[35,40,44,62],[55,58,50,47],[41,59,45,64],[65,70,84,85],[66,95,71,74],[68,69,81,86],[88,92,78,83],[80,89,75,93],[67,72,76,94],[87,90,82,79],[73,91,77,96],[97,102,116,117],[98,127,103,106],[100,101,113,118],[120,124,110,115],[112,121,107,125],[99,104,108,126],[119,122,114,111],[105,123,109,128]],
            [[1,16,18,30],[2,14,17,32],[4,23,28,13],[27,31,19,21],[22,8,25,10],[3,5,11,15],[6,24,9,26],[20,7,12,29],[33,48,50,62],[34,46,49,64],[36,55,60,45],[59,63,51,53],[54,40,57,42],[35,37,43,47],[38,56,41,58],[52,39,44,61],[65,80,82,94],[66,78,81,96],[68,87,92,77],[91,95,83,85],[86,72,89,74],[67,69,75,79],[70,88,73,90],[84,71,76,93],[97,112,114,126],[98,110,113,128],[100,119,124,109],[123,127,115,117],[118,104,121,106],[99,101,107,111],[102,120,105,122],[116,103,108,125]],
            [[1,26,13,7],[2,9,21,15],[4,24,16,12],[23,17,10,29],[19,22,11,30],[3,6,27,14],[5,31,18,25],[28,20,8,32],[33,58,45,39],[34,41,53,47],[36,56,48,44],[55,49,42,61],[51,54,43,62],[35,38,59,46],[37,63,50,57],[60,52,40,64],[65,90,77,71],[66,73,85,79],[68,88,80,76],[87,81,74,93],[83,86,75,94],[67,70,91,78],[69,95,82,89],[92,84,72,96],[97,122,109,103],[98,105,117,111],[100,120,112,108],[119,113,106,125],[115,118,107,126],[99,102,123,110],[101,127,114,121],[124,116,104,128]],
            [[1,27,8,15],[2,13,22,12],[4,26,21,30],[6,28,18,29],[9,16,19,7],[3,23,25,32],[5,14,20,10],[24,31,17,11],[33,59,40,47],[34,45,54,44],[36,58,53,62],[38,60,50,61],[41,48,51,39],[35,55,57,64],[37,46,52,42],[56,63,49,43],[65,91,72,79],[66,77,86,76],[68,90,85,94],[70,92,82,93],[73,80,83,71],[67,87,89,96],[69,78,84,74],[88,95,81,75],[97,123,104,111],[98,109,118,108],[100,122,117,126],[102,124,114,125],[105,112,115,103],[99,119,121,128],[101,110,116,106],[120,127,113,107]]
        ]
    }
}

def get_pairs_from_group(group):
    """Get all player pairs from a group"""
    return set(itertools.combinations(sorted(group), 2))

def check_seating_for_duplicates(seating_data, player_names_map):
    """Check for duplicate pairs and players"""
    all_pairs = set()
    errors = []
    duplicate_players = {}
    
    for r_idx, round_data in enumerate(seating_data["rounds"]):
        round_players = set()
        round_duplicates = set()
        
        for t_idx, table in enumerate(round_data):
            for player in table:
                if player in round_players:
                    round_duplicates.add(player)
                    errors.append(f"⚠️ Player {player_names_map.get(player)} repeats in round {r_idx+1}")
                round_players.add(player)
            
            table_pairs = get_pairs_from_group(table)
            for pair in table_pairs:
                if pair in all_pairs:
                    errors.append(f"⚠️ Pair {pair} repeats in round {r_idx+1}")
                all_pairs.add(pair)
        
        if round_duplicates:
            duplicate_players[r_idx] = round_duplicates
    
    return {
        'has_errors': bool(errors),
        'errors': errors,
        'duplicate_players': duplicate_players
    }

# ===== APPLICATION =====


if 'config' not in st.session_state:
    st.session_state.config = {
        'group_size': 3,
        'player_count': None,
        'player_names': [],
        'rounds_to_play': 1
    }

# Tournament setup
st.header("Počet hráčů u stolu")

# Group size selection (ZMĚNA: Správná aktualizace session_state)
group_size = st.radio(
    "Počet hráčů u stolu:",
    [3, 4],
    index=0 if st.session_state.config['group_size'] == 3 else 1,
    key='group_size_selector'
)
if group_size != st.session_state.config['group_size']:
    st.session_state.config['group_size'] = group_size
    st.session_state.config['player_count'] = None
    st.rerun()

# Available configurations
available_configs = [
    key for key in SEATING_DEFINITIONS.keys() 
    if int(key.split('_')[1]) == st.session_state.config['group_size']
]

if not available_configs:
    st.error("No seating arrangements available for this group size")
    st.stop()

# Player count selection (ZMĚNA: Lepší handling změn)
player_count_options = sorted([int(key.split('_')[0]) for key in available_configs])
player_count = st.selectbox(
    "Vyber počet hráčů:",
    options=player_count_options,
    index=player_count_options.index(st.session_state.config['player_count']) if st.session_state.config['player_count'] in player_count_options else 0,
    key='player_count_selector'
)
if player_count != st.session_state.config['player_count']:
    st.session_state.config['player_count'] = player_count
    st.session_state.config['player_names'] = [f"Player {i+1}" for i in range(player_count)] if player_count else []
    st.rerun()

# Load seating definition
config_key = f"{st.session_state.config['player_count']}_{st.session_state.config['group_size']}"
seating_def = SEATING_DEFINITIONS.get(config_key)

if not seating_def:
    st.error(f"No seating arrangement available for {st.session_state.config['player_count']} players in groups of {st.session_state.config['group_size']}")
    st.stop()

# Rounds selection (ZMĚNA: Oprava výběru kol)
max_rounds = len(seating_def['rounds'])
rounds_to_play = st.selectbox(
    "Zadej počet kol:",
    options=range(1, max_rounds + 1),
    index=min(3, max_rounds) - 1,
    key='rounds_selector'
)
st.session_state.config['rounds_to_play'] = rounds_to_play

# Player names input (ZMĚNA: Lepší synchronizace jmen)
st.header("Zadej jména hráčů")
if len(st.session_state.config['player_names']) != st.session_state.config['player_count']:
    st.session_state.config['player_names'] = [f"Player {i+1}" for i in range(st.session_state.config['player_count'])]

player_names = []
for i in range(st.session_state.config['player_count']):
    name = st.text_input(
        f"Hráč {i+1}",
        value=st.session_state.config['player_names'][i],
        key=f'player_name_{i}'
    )
    player_names.append(name)

# Check for duplicate names
if len(set(player_names)) != len(player_names):
    duplicates = [name for name, count in Counter(player_names).items() if count > 1]
    st.error(f"Player names must be unique! Duplicates: {', '.join(duplicates)}")

# Display seating arrangement (ZMĚNA: Lepší kontrola rozlosování)
if st.button("Zobraz rozlosování"):
    player_map = {i+1: name for i, name in enumerate(player_names)}
    check_result = check_seating_for_duplicates(
        {'rounds': seating_def['rounds'][:st.session_state.config['rounds_to_play']], 'player_count': st.session_state.config['player_count']},
        player_map
    )
    
    if check_result['has_errors']:
        for error in check_result['errors']:
            st.error(error)
    else:
        st.success("Seating arrangement is valid, no duplicates found")
        
        for r_idx in range(st.session_state.config['rounds_to_play']):
            st.subheader(f"{r_idx + 1}. Kolo ")
            round_tables = seating_def['rounds'][r_idx]
            
            cols = st.columns(len(round_tables))
            for t_idx, table in enumerate(round_tables):
                with cols[t_idx]:
                    st.markdown(f"**Stůl {t_idx + 1}**")
                    st.write(", ".join([player_map[p] for p in table]))